<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Flow | Creator Edition</title>
    
    <style>
        /* ================= ËÆæËÆ°Á≥ªÁªü ================= */
        :root {
            --accent: #00f3ff; 
            --accent-glow: rgba(0, 243, 255, 0.4);
            --glass-bg: rgba(18, 18, 20, 0.65);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-primary: rgba(255, 255, 255, 0.98);
            --text-secondary: rgba(255, 255, 255, 0.6);
            --font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            --ease-apple: cubic-bezier(0.25, 1, 0.5, 1);
        }

        body {
            margin: 0; overflow: hidden; background-color: #000;
            font-family: var(--font-family); color: var(--text-primary); user-select: none;
            transition: background-color 1s ease;
        }

        #canvas-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }

        /* ================= UI Âü∫Á°Ä ================= */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: saturate(180%) blur(40px);
            -webkit-backdrop-filter: saturate(180%) blur(40px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 24px 48px rgba(0,0,0,0.5);
            border-radius: 28px;
            transition: all 0.5s var(--ease-apple);
        }

        .section-header {
            font-size: 11px; text-transform: uppercase; letter-spacing: 1.2px;
            color: var(--text-secondary); margin: 20px 0 10px 4px; font-weight: 600;
        }

        /* ================= È°∂ÈÉ®ÂàáÊç¢Ê†è (New) ================= */
        #mode-switcher {
            position: absolute; top: 24px; right: 24px; z-index: 50;
            background: rgba(0,0,0,0.3); border-radius: 20px; padding: 4px;
            display: flex; gap: 4px; border: 1px solid var(--glass-border);
        }
        .mode-btn {
            padding: 6px 14px; border-radius: 16px; font-size: 12px; cursor: pointer;
            color: var(--text-secondary); transition: 0.3s;
        }
        .mode-btn.active { background: rgba(255,255,255,0.15); color: white; font-weight: 600; }

        /* ================= Èü≥‰πêÁºñÁ®ãÈù¢Êùø (Maker Panel) ================= */
        #maker-panel {
            position: absolute; bottom: 110px; right: 24px; width: 280px;
            max-height: 60vh; overflow-y: auto; z-index: 10; padding: 24px;
            transform: translateX(0); opacity: 1;
        }
        #maker-panel.hidden { transform: translateX(50px); opacity: 0; pointer-events: none; }

        /* ‰πêÂô®ÁΩëÊ†º */
        .inst-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .inst-btn {
            background: rgba(255,255,255,0.06); border-radius: 16px; padding: 15px;
            cursor: pointer; transition: 0.2s; border: 1px solid transparent;
            display: flex; flex-direction: column; align-items: center; gap: 8px;
        }
        .inst-btn:hover { background: rgba(255,255,255,0.1); }
        .inst-btn.active { background: var(--accent); color: #000; box-shadow: 0 0 15px var(--accent-glow); }
        .inst-icon { font-size: 24px; }
        .inst-name { font-size: 12px; font-weight: 600; }

        /* ËäÇÂ•èÈÄâÊã© */
        .rhythm-row { display: flex; gap: 8px; margin-bottom: 20px; }
        .rhythm-btn {
            flex: 1; padding: 10px; text-align: center; border-radius: 12px;
            background: rgba(255,255,255,0.06); font-size: 11px; cursor: pointer; transition: 0.2s;
        }
        .rhythm-btn.active { background: white; color: black; font-weight: bold; }

        /* Êí≠ÊîæÊéßÂà∂Â§ßÊåâÈíÆ */
        #maker-play-btn {
            width: 100%; padding: 14px; border-radius: 18px;
            background: white; color: black; font-weight: 700; font-size: 14px;
            border: none; cursor: pointer; margin-top: 20px; display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.2s;
        }
        #maker-play-btn:hover { transform: scale(1.02); }
        #maker-play-btn.playing { background: var(--accent); box-shadow: 0 0 20px var(--accent-glow); }

        /* ================= Settings Panel (ÂéüËÆæÁΩÆÈù¢Êùø) ================= */
        #settings-panel {
            position: absolute; bottom: 110px; right: 24px; width: 280px;
            max-height: 60vh; overflow-y: auto; z-index: 10; padding: 24px;
        }
        #settings-panel.hidden { transform: translateX(50px); opacity: 0; pointer-events: none; }

        /* Â§çÁî®‰πãÂâçÁöÑÊ†∑Âºè */
        .shape-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .shape-btn { aspect-ratio: 1; background: rgba(255,255,255,0.06); border-radius: 14px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; }
        .shape-btn.active { background: var(--accent); color:black; }
        input[type=range] { width: 100%; -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: rgba(255,255,255,0.15); border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { height: 16px; width: 16px; border-radius: 50%; background: white; -webkit-appearance: none; margin-top: -6px; }

        /* Layout */
        #library-panel { position: absolute; top: 24px; left: 24px; width: 260px; height: calc(100vh - 140px); z-index: 10; display: flex; flex-direction: column; padding: 24px; }
        #player-bar { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 480px; height: 68px; z-index: 100; padding: 0 24px; display: flex; align-items: center; justify-content: space-between; border-radius: 34px; }
        
        /* Hidden elements */
        input[type="file"] { display: none; }
        .art-box { width: 42px; height: 42px; border-radius: 12px; background: var(--accent); display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <!-- È°∂ÈÉ®Ê®°ÂºèÂàáÊç¢ -->
    <div id="mode-switcher">
        <div class="mode-btn active" onclick="switchMode('settings')" id="btn-mode-settings">Settings</div>
        <div class="mode-btn" onclick="switchMode('maker')" id="btn-mode-maker">üéπ Maker</div>
    </div>

    <!-- Èù¢Êùø 1: ÂéüËÆæÁΩÆÈù¢Êùø -->
    <div id="settings-panel" class="glass-panel">
        <div class="section-header">Visual Style</div>
        <div class="shape-grid" id="shape-grid"></div>
        <div class="section-header" style="margin-top:20px">Effects</div>
        <div style="font-size:12px; margin-bottom:5px; display:flex; justify-content:space-between;"><span>Explosion</span><span id="val-exp">0.5</span></div>
        <input type="range" min="0" max="2" step="0.1" value="0.5" oninput="setParam('explode', this.value)">
    </div>

    <!-- Èù¢Êùø 2: Èü≥‰πêÁºñÁ®ãÈù¢Êùø (NEW) -->
    <div id="maker-panel" class="glass-panel hidden">
        <div class="section-header" style="margin-top:0">Instrument</div>
        <div class="inst-grid">
            <div class="inst-btn active" onclick="setInst('pad', this)">
                <div class="inst-icon">‚òÅÔ∏è</div>
                <div class="inst-name">Ether Pad</div>
            </div>
            <div class="inst-btn" onclick="setInst('pluck', this)">
                <div class="inst-icon">üé∏</div>
                <div class="inst-name">Cosmic Pluck</div>
            </div>
            <div class="inst-btn" onclick="setInst('bass', this)">
                <div class="inst-icon">üîä</div>
                <div class="inst-name">Deep Bass</div>
            </div>
            <div class="inst-btn" onclick="setInst('lead', this)">
                <div class="inst-icon">‚ö°Ô∏è</div>
                <div class="inst-name">Neon Lead</div>
            </div>
        </div>

        <div class="section-header">Rhythm Pattern</div>
        <div class="rhythm-row">
            <div class="rhythm-btn active" onclick="setRhythm('flow', this)">Flow</div>
            <div class="rhythm-btn" onclick="setRhythm('pulse', this)">Pulse</div>
            <div class="rhythm-btn" onclick="setRhythm('chaos', this)">Chaos</div>
        </div>

        <div class="section-header">Intensity / Speed</div>
        <input type="range" min="0.1" max="1.0" step="0.1" value="0.5" oninput="setMakerIntensity(this.value)">

        <button id="maker-play-btn" onclick="toggleMaker()">
            <span>‚ñ∂</span> Start Generation
        </button>
    </div>

    <!-- Â∑¶‰æßÂ∫ì -->
    <div id="library-panel" class="glass-panel">
        <div style="font-size:22px; font-weight:700; margin-bottom:15px;">Library</div>
        <div style="font-size:12px; color:var(--text-secondary); margin-bottom:15px;">Or use the Maker to generate music.</div>
        <ul id="playlist"></ul>
    </div>

    <!-- Â∫ïÈÉ®Êí≠ÊîæÂô® -->
    <div id="player-bar" class="glass-panel">
        <div style="display:flex; align-items:center; gap:16px;">
            <div class="art-box">üéµ</div>
            <div>
                <div style="font-size:14px; font-weight:600;" id="now-title">Ready</div>
                <div style="font-size:10px; color:var(--accent); font-family:monospace;" id="now-source">WAITING...</div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        // ================= SYNTH ENGINE (WEB AUDIO API) =================
        const AudioEngine = {
            ctx: null,
            masterGain: null,
            analyser: null,
            isPlaying: false,
            timer: null,
            tempo: 200, // ms per beat
            scale: [130.81, 146.83, 164.81, 196.00, 220.00, 261.63, 293.66, 329.63, 392.00, 440.00], // C Pentatonic
            config: { inst: 'pad', rhythm: 'flow', intensity: 0.5 },

            init() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    this.masterGain = this.ctx.createGain();
                    this.masterGain.gain.value = 0.3;
                    this.analyser = this.ctx.createAnalyser();
                    this.analyser.fftSize = 512;
                    this.masterGain.connect(this.analyser);
                    this.analyser.connect(this.ctx.destination);
                }
                if (this.ctx.state === 'suspended') this.ctx.resume();
            },

            playNote(freq, dur) {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                
                // Instrument Logic
                switch(this.config.inst) {
                    case 'pad':
                        osc.type = 'sine';
                        gain.gain.setValueAtTime(0, this.ctx.currentTime);
                        gain.gain.linearRampToValueAtTime(0.3, this.ctx.currentTime + dur/2);
                        gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + dur);
                        break;
                    case 'bass':
                        osc.type = 'sawtooth';
                        osc.frequency.value = freq / 2; // Octave down
                        gain.gain.setValueAtTime(0.5, this.ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.3);
                        break;
                    case 'pluck':
                        osc.type = 'triangle';
                        gain.gain.setValueAtTime(0.4, this.ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.5);
                        break;
                    case 'lead':
                        osc.type = 'square';
                        gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                        gain.gain.linearRampToValueAtTime(0.2, this.ctx.currentTime + 0.1);
                        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.4);
                        break;
                }

                osc.connect(gain);
                gain.connect(this.masterGain);
                osc.start();
                osc.stop(this.ctx.currentTime + dur + 1);
            },

            step() {
                // Generative Sequencer Logic
                let chance = 0.5;
                if (this.config.rhythm === 'flow') chance = 0.3;
                if (this.config.rhythm === 'chaos') chance = 0.8;

                if (Math.random() < chance * (1 + this.config.intensity)) {
                    // Pick random note from scale
                    const note = this.scale[Math.floor(Math.random() * this.scale.length)];
                    // Duration based on intensity
                    const dur = (2.0 - this.config.intensity) * (this.tempo / 1000);
                    this.playNote(note, dur);
                    
                    // Visual feedback hack
                    material.uniforms.uBeat.value = 0.5 + this.config.intensity; // Force visual pulse
                }
            },

            start() {
                this.init();
                this.isPlaying = true;
                this.timer = setInterval(() => this.step(), this.tempo);
                document.getElementById('maker-play-btn').classList.add('playing');
                document.getElementById('maker-play-btn').innerHTML = `<span>‚è∏</span> Generating...`;
                document.getElementById('now-title').innerText = "AI Generating";
                document.getElementById('now-source').innerText = `INST: ${this.config.inst.toUpperCase()}`;
            },

            stop() {
                this.isPlaying = false;
                clearInterval(this.timer);
                document.getElementById('maker-play-btn').classList.remove('playing');
                document.getElementById('maker-play-btn').innerHTML = `<span>‚ñ∂</span> Start Generation`;
                document.getElementById('now-title').innerText = "Paused";
                // Reset visuals
                material.uniforms.uBeat.value = 0;
            }
        };

        // ================= CONFIG & VISUALS =================
        const CONFIG = { count: 30000, explode: 0.5 };
        const SHAPES = [
            { id: 'galaxy', name: 'Galaxy', icon: 'üåå' },
            { id: 'dna', name: 'DNA', icon: 'üß¨' },
            { id: 'sphere', name: 'Sphere', icon: 'üîÆ' },
            { id: 'grid', name: 'Grid', icon: 'üï∏Ô∏è' }
        ];

        let scene, camera, renderer, particles, material, geometry, controls, clock;

        function init() {
            const container = document.getElementById('canvas-container');
            clock = new THREE.Clock();
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x050505, 0.002);
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 3000);
            camera.position.set(0, 50, 450);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x050505);
            container.appendChild(renderer.domElement);
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; controls.autoRotate = true; controls.autoRotateSpeed = 0.5;
            
            initParticles();
            initUI();
            
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth/window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            animate();
        }

        function initParticles() {
            geometry = new THREE.BufferGeometry();
            const pos = new Float32Array(CONFIG.count*3);
            const target = new Float32Array(CONFIG.count*3);
            const colors = new Float32Array(CONFIG.count*3);
            const shape = getShapeData('galaxy');
            for(let i=0; i<CONFIG.count; i++) {
                pos[i*3]=shape[i*3]; pos[i*3+1]=shape[i*3+1]; pos[i*3+2]=shape[i*3+2];
                target[i*3]=pos[i*3]; target[i*3+1]=pos[i*3+1]; target[i*3+2]=pos[i*3+2];
                colors[i*3]=0.1; colors[i*3+1]=0.5; colors[i*3+2]=1.0;
            }
            geometry.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            geometry.setAttribute('targetPosition', new THREE.BufferAttribute(target, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

            const vShader = `
                uniform float uTime; uniform float uMix; uniform float uBeat; uniform float uExplode;
                attribute vec3 targetPosition; attribute vec3 color; varying vec3 vColor; varying float vAlpha;
                void main() {
                    vColor = color;
                    vec3 pos = mix(position, targetPosition, uMix);
                    float n = sin(pos.x*0.01 + uTime) * cos(pos.z*0.01 + uTime);
                    pos += normalize(pos) * (n*20.0 + uBeat*uExplode*60.0);
                    vec4 mvPos = modelViewMatrix * vec4(pos, 1.0);
                    gl_Position = projectionMatrix * mvPos;
                    gl_PointSize = 2.0 * (1.0 + uBeat * 2.0) * (300.0 / -mvPos.z);
                    vAlpha = smoothstep(1000.0, 100.0, -mvPos.z);
                }
            `;
            const fShader = `
                varying vec3 vColor; varying float vAlpha; uniform float uBeat;
                void main() {
                    vec2 uv = gl_PointCoord.xy - 0.5;
                    if (length(uv) > 0.5) discard;
                    vec3 c = mix(vColor, vec3(1.0), uBeat * 0.5);
                    gl_FragColor = vec4(c, vAlpha);
                }
            `;
            material = new THREE.ShaderMaterial({
                uniforms: { uTime:{value:0}, uMix:{value:0}, uBeat:{value:0}, uExplode:{value:CONFIG.explode} },
                vertexShader: vShader, fragmentShader: fShader, transparent: true, depthWrite: false, blending: THREE.AdditiveBlending
            });
            particles = new THREE.Points(geometry, material);
            scene.add(particles);
        }

        function getShapeData(type) {
            const arr = new Float32Array(CONFIG.count*3); let idx=0;
            for(let i=0; i<CONFIG.count; i++) {
                let x,y,z, u=Math.random()*Math.PI*2, v=Math.random()*Math.PI, r=150;
                if(type==='galaxy'){ const a=Math.random()*Math.PI*2,d=Math.random()*200; x=Math.cos(a+d*0.05)*d; y=(Math.random()-0.5)*20; z=Math.sin(a+d*0.05)*d; }
                else if(type==='dna'){ x=Math.cos(u*5)*60; z=Math.sin(u*5)*60; y=(u-Math.PI*5)*20; if(i%2==0)x+=20; }
                else if(type==='grid'){ x=(Math.random()-0.5)*400; z=(Math.random()-0.5)*400; y=Math.floor((Math.random()-0.5)*5)*40; }
                else { x=r*Math.sin(v)*Math.cos(u); y=r*Math.sin(v)*Math.sin(u); z=r*Math.cos(v); }
                arr[idx++]=x; arr[idx++]=y; arr[idx++]=z;
            }
            return arr;
        }

        function morphTo(type) {
            geometry.attributes.position.array.set(geometry.attributes.targetPosition.array);
            geometry.attributes.position.needsUpdate = true;
            geometry.attributes.targetPosition.array.set(getShapeData(type));
            geometry.attributes.targetPosition.needsUpdate = true;
            material.uniforms.uMix.value = 0;
            const start = clock.getElapsedTime();
            const anim = () => {
                const p = Math.min((clock.getElapsedTime()-start)/2, 1);
                material.uniforms.uMix.value = 1 - Math.pow(1-p, 3);
                if(p<1) requestAnimationFrame(anim);
            };
            anim();
            document.querySelectorAll('.shape-btn').forEach(b => { b.classList.remove('active'); if(b.dataset.id === type) b.classList.add('active'); });
        }

        // ================= UI INTERACTION =================
        function initUI() {
            const sGrid = document.getElementById('shape-grid');
            SHAPES.forEach((s,i) => {
                const b = document.createElement('div'); b.className=`shape-btn ${i===0?'active':''}`; b.dataset.id=s.id;
                b.innerHTML = `<div style="font-size:20px">${s.icon}</div><span>${s.name}</span>`;
                b.onclick = () => morphTo(s.id); sGrid.appendChild(b);
            });
            
            // Dummy Playlist
            const pl = document.getElementById('playlist');
            ['Local Files', 'Create with Maker'].forEach(n => {
                const li = document.createElement('li'); li.innerHTML = n; 
                li.style.padding='10px'; li.style.opacity='0.6'; li.style.borderBottom='1px solid rgba(255,255,255,0.1)';
                pl.appendChild(li);
            });
        }

        // MAKER CONTROLS
        function switchMode(mode) {
            const settings = document.getElementById('settings-panel');
            const maker = document.getElementById('maker-panel');
            const b1 = document.getElementById('btn-mode-settings');
            const b2 = document.getElementById('btn-mode-maker');

            if(mode === 'settings') {
                settings.classList.remove('hidden'); maker.classList.add('hidden');
                b1.classList.add('active'); b2.classList.remove('active');
            } else {
                settings.classList.add('hidden'); maker.classList.remove('hidden');
                b1.classList.remove('active'); b2.classList.add('active');
            }
        }

        function setInst(type, btn) {
            AudioEngine.config.inst = type;
            document.querySelectorAll('.inst-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function setRhythm(type, btn) {
            AudioEngine.config.rhythm = type;
            document.querySelectorAll('.rhythm-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function setMakerIntensity(val) {
            AudioEngine.config.intensity = parseFloat(val);
            AudioEngine.tempo = 400 - (val * 300); // 0.1->370ms, 1.0->100ms
            if(AudioEngine.isPlaying) {
                clearInterval(AudioEngine.timer);
                AudioEngine.timer = setInterval(() => AudioEngine.step(), AudioEngine.tempo);
            }
        }

        function toggleMaker() {
            if(AudioEngine.isPlaying) AudioEngine.stop(); else AudioEngine.start();
        }

        window.setParam = (k, v) => { if(material && k==='explode') material.uniforms.uExplode.value = parseFloat(v); };

        // ================= LOOP =================
        function animate() {
            requestAnimationFrame(animate);
            material.uniforms.uTime.value = clock.getElapsedTime();
            
            // Visualizer Logic: If Synth is playing, get data from it
            if(AudioEngine.isPlaying && AudioEngine.analyser) {
                const data = new Uint8Array(AudioEngine.analyser.frequencyBinCount);
                AudioEngine.analyser.getByteFrequencyData(data);
                let sum=0; for(let i=0;i<50;i++) sum+=data[i];
                // Smoothly update beat visual
                material.uniforms.uBeat.value += (sum/50/255 - material.uniforms.uBeat.value)*0.2;
            } else {
                 // Decay beat if stopped
                 material.uniforms.uBeat.value *= 0.95;
            }

            controls.update(); renderer.render(scene, camera);
        }
        init();
    </script>
</body>
</html>